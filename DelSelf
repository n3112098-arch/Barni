from .. import loader, utils
import asyncio

class DelSel(loader.Module):
    """–£–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""

    strings = {"name": "DelSel"}

    def __init__(self):
        self._del_targets = {}  # —á–∞—Ç: {user_ids}

    @loader.command()
    async def dsms(self, m):
        """–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ"""
        me = await m.client.get_me()

        await m.edit("üóë –ù–∞—á–∏–Ω–∞—é —É–¥–∞–ª–µ–Ω–∏–µ –≤–∞—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...")

        deleted = 0

        async for msg in m.client.iter_messages(m.chat_id):
            if msg.sender_id == me.id:
                try:
                    await msg.delete()
                    deleted += 1
                    await asyncio.sleep(0.05)
                except:
                    pass

        await m.edit(f"‚úîÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {deleted}")

    @loader.command()
    async def delusr(self, m):
        """
        @user ‚Äî —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
        """
        if not m.chat:
            return await m.edit("‚ùå –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö.")

        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–£–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `.delusr @username`")

        try:
            ent = await m.client.get_entity(args)
        except:
            return await m.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

        uid = ent.id
        chat = m.chat_id

        self._del_targets.setdefault(chat, set()).add(uid)

        await m.edit(f"üõë –¢–µ–ø–µ—Ä—å –≤—Å–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç {ent.first_name} –±—É–¥—É—Ç —É–¥–∞–ª—è—Ç—å—Å—è.")

    @loader.command()
    async def undelusr(self, m):
        """
        @user ‚Äî –æ—Ç–∫–ª—é—á–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–£–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `@username`")

        try:
            ent = await m.client.get_entity(args)
        except:
            return await m.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

        uid = ent.id
        chat = m.chat_id

        if chat in self._del_targets and uid in self._del_targets[chat]:
            self._del_targets[chat].remove(uid)
            return await m.edit(f"üü© –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π {ent.first_name} –≤—ã–∫–ª—é—á–µ–Ω–æ.")

        await m.edit("‚ùó –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª –≤–∫–ª—é—á—ë–Ω —Ä–∞–Ω–µ–µ.")

    async def watcher(self, m):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        if not m or not m.chat or not m.sender_id:
            return

        chat = m.chat_id
        sender = m.sender_id

        if chat in self._del_targets and sender in self._del_targets[chat]:
            try:
                await m.delete()
            except:
                pass
