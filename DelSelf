# meta developer: @B_Mods
from .. import loader, utils
import asyncio

@loader.tds
class DelSel(loader.Module):
    """–£–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —é–∑–µ—Ä–∞"""
    strings = {"name": "DelSel"}

    async def client_ready(self, client, db):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–ª–µ–π –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏—è: {chat_id: {user_id, ...}}
        self._del_targets = {}
        self._db = db

    # ---------------------------------------
    # –£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
    # ---------------------------------------
    @loader.command()
    async def dsms(self, m):
        """.dsms ‚Äî —É–¥–∞–ª–∏—Ç—å –í–°–ï —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ"""
        me = await m.client.get_me()
        await m.edit("üóë –ù–∞—á–∏–Ω–∞—é —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...")

        deleted = 0
        # –ü—Ä–æ—Ö–æ–¥ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º —á–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–≤–µ—Ä—Ö—É)
        async for msg in m.client.iter_messages(m.chat_id):
            try:
                if msg.sender_id == me.id:
                    await msg.delete()
                    deleted += 1
                    await asyncio.sleep(0.05)  # –∑–∞—â–∏—Ç–Ω—ã–π —Ç–∞–π–º-–∞—É—Ç
            except Exception:
                # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ (–Ω–µ—Ç –ø—Ä–∞–≤, floodwait –∏ —Ç.–ø.)
                pass

        await m.client.send_message(m.chat_id, f"‚úîÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {deleted}")

    # ---------------------------------------
    # –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # ---------------------------------------
    @loader.command()
    async def delusr(self, m):
        """
        .delusr <user> ‚Äî –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ
        (–Ω–∞–ø—Ä–∏–º–µ—Ä: .delusr @username –∏–ª–∏ .delusr user_id)
        """
        if not m.chat:
            return await m.edit("‚ùó –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —á–∞—Ç–∞—Ö/–≥—Ä—É–ø–ø–∞—Ö.")

        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `.delusr @username`")

        try:
            ent = await m.client.get_entity(args)
        except Exception:
            return await m.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–≤–µ—Ä—å —É–∫–∞–∑–∞–Ω–Ω—ã–π –Ω–∏–∫/ID.")

        uid = ent.id
        chat_id = m.chat_id

        self._del_targets.setdefault(chat_id, set()).add(uid)
        await m.edit(f"üóë –¢–µ–ø–µ—Ä—å –≤—Å–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç **{ent.first_name or ent.username or uid}** –±—É–¥—É—Ç —É–¥–∞–ª—è—Ç—å—Å—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ.")

    # ---------------------------------------
    # –í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # ---------------------------------------
    @loader.command()
    async def undelusr(self, m):
        """
        .undelusr <user> ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `.undelusr @username`")

        try:
            ent = await m.client.get_entity(args)
        except Exception:
            return await m.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

        uid = ent.id
        chat_id = m.chat_id

        if chat_id in self._del_targets and uid in self._del_targets[chat_id]:
            self._del_targets[chat_id].remove(uid)
            return await m.edit(f"üü© –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π **{ent.first_name or ent.username or uid}** –æ—Ç–∫–ª—é—á–µ–Ω–æ.")
        else:
            return await m.edit("‚ÑπÔ∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª –≤–∫–ª—é—á—ë–Ω –≤ –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")

    # ---------------------------------------
    # Watcher ‚Äî —É–¥–∞–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ü–µ–ª–µ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # ---------------------------------------
    async def watcher(self, m):
        # –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
        if not m or not getattr(m, "chat_id", None) or not getattr(m, "sender_id", None):
            return

        chat_id = m.chat_id
        sender_id = m.sender_id

        # –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ü–µ–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
        targets = self._del_targets.get(chat_id)
        if not targets:
            return

        if sender_id in targets:
            # –ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å; –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ (–Ω–µ—Ç –ø—Ä–∞–≤ –∏ —Ç.–ø.)
            try:
                await m.delete()
            except Exception:
                pass