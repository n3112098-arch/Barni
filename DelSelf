from .. import loader, utils
import asyncio
from telethon.errors import FloodWaitError


@loader.tds
class DelSel(loader.Module):
    """–£–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π + –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—É—Å–∫–æ—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""

    strings = {"name": "DelSel"}

    async def client_ready(self, client, db):
        self.client = client
        self._del_targets = {}

    @loader.command()
    async def dsms(self, m):
        """–£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ (–±—ã—Å—Ç—Ä–æ)"""
        me = await self.client.get_me()
        chat_id = m.chat_id

        await m.edit("üóë –ë—ã—Å—Ç—Ä–æ —É–¥–∞–ª—è—é —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è...")

        deleted = 0
        batch = 0

        async for msg in self.client.iter_messages(chat_id):
            if msg.sender_id != me.id:
                continue

            try:
                await msg.delete()
                deleted += 1
                batch += 1

                # –º–∏–∫—Ä–æ–ø–∞—É–∑–∞ –∫–∞–∂–¥—ã–µ 15 —Å–æ–æ–±—â–µ–Ω–∏–π
                if batch >= 15:
                    batch = 0
                    await asyncio.sleep(0.2)

            except FloodWaitError as e:
                await asyncio.sleep(e.seconds)
            except:
                pass

        await m.client.send_message(chat_id, f"‚úîÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {deleted}")

    @loader.command()
    async def delusr(self, m):
        """
        .delusr @user ‚Äî —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –ù–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        (–Ω—É–∂–Ω–æ –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º)
        """
        if not m.chat:
            return await m.edit("‚ùå –¢–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö")

        user = await utils.get_user(m)
        if not user:
            return await m.edit("‚ùå –£–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

        chat_id = m.chat_id
        self._del_targets.setdefault(chat_id, set()).add(user.id)

        await m.edit(f"üóë –¢–µ–ø–µ—Ä—å —Å–æ–æ–±—â–µ–Ω–∏—è **{user.first_name}** –±—É–¥—É—Ç —É–¥–∞–ª—è—Ç—å—Å—è")

    @loader.command()
    async def undelusr(self, m):
        """–û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = await utils.get_user(m)
        if not user:
            return await m.edit("‚ùå –£–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

        chat_id = m.chat_id

        if chat_id in self._del_targets and user.id in self._del_targets[chat_id]:
            self._del_targets[chat_id].remove(user.id)
            return await m.edit(f"üü¢ –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π **{user.first_name}** –æ—Ç–∫–ª—é—á–µ–Ω–æ")

        await m.edit("‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª –≤ —Å–ø–∏—Å–∫–µ")

    async def watcher(self, m):
        """–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        if not m or not m.chat or not m.sender_id:
            return

        chat_id = m.chat_id
        sender_id = m.sender_id

        if chat_id not in self._del_targets:
            return

        if sender_id not in self._del_targets[chat_id]:
            return

        try:
            await m.delete()
        except FloodWaitError as e:
            await asyncio.sleep(e.seconds)
        except:
            pass