from .. import loader, utils
import asyncio

class DeleteSelfMessages(loader.Module):
    """–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ"""

    strings = {"name": "DelSelf"}

    @loader.command()
    async def dsms(self, m):
        """–£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ"""
        me = await m.client.get_me()

        await m.edit("üóë –ù–∞—á–∏–Ω–∞—é —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...")

        deleted = 0

        async for msg in m.client.iter_messages(m.chat_id):
            try:
                if msg.sender_id == me.id:
                    await msg.delete()
                    deleted += 1
                    await asyncio.sleep(0.05)  # —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å FloodWait
            except:
                pass

        await m.client.send_message(
            m.chat_id,
            f"‚úîÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {deleted}"
        )
        @loader.command()
    async def delusr(self, m):
        """
        .delusr @user ‚Äî —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–∫–∞ –º–æ–¥—É–ª—å –≤–∫–ª—é—á—ë–Ω)
        –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –∞–¥–º–∏–Ω –≤ —á–∞—Ç–µ.
        """
        if not m.chat:
            return await m.edit("–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö.")

        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–£–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `.delusr @username`")

        try:
            ent = await m.client.get_entity(args)
        except:
            return await m.edit("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

        uid = ent.id
        chat_id = m.chat_id

        self._del_targets.setdefault(chat_id, set()).add(uid)
        await m.edit(f"üóë –¢–µ–ø–µ—Ä—å –≤—Å–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç {ent.first_name} –±—É–¥—É—Ç —É–¥–∞–ª—è—Ç—å—Å—è.")

    @loader.command()
    async def undelusr(self, m):
        """
        .undelusr @user ‚Äî –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–£–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `.undelusr @username`")

        try:
            ent = await m.client.get_entity(args)
        except:
            return await m.edit("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

        uid = ent.id
        chat_id = m.chat_id

        if chat_id in self._del_targets and uid in self._del_targets[chat_id]:
            self._del_targets[chat_id].remove(uid)
            return await m.edit(f"üü© –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π {ent.first_name} –æ—Ç–∫–ª—é—á–µ–Ω–æ.")

        await m.edit("–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª –≤–∫–ª—é—á—ë–Ω.")

    async def watcher(self, m):
        """
        –õ–æ–≤–∏—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —É–¥–∞–ª—è–µ—Ç –∏—Ö
        """
        if not hasattr(self, "_del_targets"):
            self._del_targets = {}

        if not m or not m.chat or not m.sender_id:
            return

        chat_id = m.chat_id
        sender_id = m.sender_id

        if chat_id in self._del_targets and sender_id in self._del_targets[chat_id]:
            try:
                await m.delete()
            except:
                pass