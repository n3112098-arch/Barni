# meta developer: @B_Mods
from .. import loader, utils

@loader.tds
class AutoReact(loader.Module):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""

    strings = {"name": "AutoReact"}

    async def client_ready(self, client, db):
        self.client = client
        self.db = db

        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
        # {
        #   "chat_id": {
        #       user_id: "‚ù§Ô∏è"
        #   }
        # }
        if not isinstance(self.db.get("AutoReact"), dict):
            self.db.set("AutoReact", {})

    def get_data(self):
        data = self.db.get("AutoReact")
        if not isinstance(data, dict):
            data = {}
            self.db.set("AutoReact", data)
        return data

    @loader.command()
    async def reak(self, m):
        """ .reak @user ‚ù§Ô∏è ‚Äî —Å—Ç–∞–≤–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∞–∫—Ü–∏—é """
        args = utils.get_args_raw(m).split(" ")

        if len(args) < 2:
            return await m.edit("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: .reak @user ‚ù§Ô∏è")

        user = args[0]
        emoji = args[1]

        try:
            ent = await m.client.get_entity(user)
        except:
            return await m.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

        uid = ent.id
        chat_id = str(m.chat_id)

        data = self.get_data()
        data.setdefault(chat_id, {})
        data[chat_id][uid] = emoji

        self.db.set("AutoReact", data)

        await m.edit(f"‚úÖ –¢–µ–ø–µ—Ä—å {ent.first_name} –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏—é {emoji}")

    @loader.command()
    async def reakoff(self, m):
        """ .reakoff @user ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∞–∫—Ü–∏—é """
        args = utils.get_args_raw(m)

        if not args:
            return await m.edit("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: .reakoff @user")

        try:
            ent = await m.client.get_entity(args)
        except:
            return await m.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

        uid = ent.id
        chat_id = str(m.chat_id)

        data = self.get_data()

        if chat_id in data and uid in data[chat_id]:
            del data[chat_id][uid]
            self.db.set("AutoReact", data)
            return await m.edit(f"üü© –î–ª—è {ent.first_name} –∞–≤—Ç–æ-—Ä–µ–∞–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.")

        await m.edit("–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª –≤–∫–ª—é—á—ë–Ω.")

    @loader.command()
    async def reaklist(self, m):
        """ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ-—Ä–µ–∞–∫—Ü–∏–π """
        data = self.get_data()
        chat_id = str(m.chat_id)

        if chat_id not in data or not data[chat_id]:
            return await m.edit("üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ-—Ä–µ–∞–∫—Ü–∏–π.")

        text = "üìå **–ê–≤—Ç–æ-—Ä–µ–∞–∫—Ü–∏–∏:**\n\n"
        for uid, emoji in data[chat_id].items():
            try:
                user = await m.client.get_entity(uid)
                name = user.first_name
            except:
                name = "Unknown"

            text += f"‚Ä¢ {name} ‚Äî {emoji}\n"

        await m.edit(text)

    async def watcher(self, m):
        """ –°—Ç–∞–≤–∏—Ç —Ä–µ–∞–∫—Ü–∏—é """
        if not m or not m.sender_id:
            return

        data = self.get_data()
        chat_id = str(getattr(m, "chat_id", None))

        if chat_id in data and m.sender_id in data[chat_id]:
            emoji = data[chat_id][m.sender_id]
            try:
                await m.react(emoji)
            except:
                pass
