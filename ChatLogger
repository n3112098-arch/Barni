from .. import loader, utils
import os
from datetime import datetime


class ChatLogger(loader.Module):
    """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ –≤ txt"""

    strings = {"name": "ChatLogger"}

    def __init__(self):
        self.config = loader.ModuleConfig(
            loader.ConfigValue(
                "enabled_chats",
                [],
                "–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, –≥–¥–µ –≤–∫–ª—é—á–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ",
            )
        )

    @loader.command()
    async def clog(self, m):
        """
        .clog on/off ‚Äî –≤–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å –ª–æ–≥
        .clog file ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥
        .clog clear ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
        """
        args = utils.get_args_raw(m)

        chat_id = str(m.chat_id)
        log_file = f"chatlog_{chat_id}.txt"

        if args == "on":
            if chat_id not in self.config["enabled_chats"]:
                self.config["enabled_chats"].append(chat_id)
            await m.edit("üü© –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.")
            return

        if args == "off":
            if chat_id in self.config["enabled_chats"]:
                self.config["enabled_chats"].remove(chat_id)
            await m.edit("üü• –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ.")
            return

        if args == "file":
            if os.path.exists(log_file):
                await m.client.send_file(m.chat_id, log_file)
                await m.edit("üìÑ –õ–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.")
            else:
                await m.edit("–õ–æ–≥ –ø—É—Å—Ç.")
            return

        if args == "clear":
            if os.path.exists(log_file):
                os.remove(log_file)
            await m.edit("üßπ –õ–æ–≥ –æ—á–∏—â–µ–Ω.")
            return

        await m.edit("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n.clog on | off | file | clear")

    async def watcher(self, m):
        if not m or not m.chat_id:
            return

        chat_id = str(m.chat_id)

        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ?
        if chat_id not in self.config["enabled_chats"]:
            return

        log_file = f"chatlog_{chat_id}.txt"

        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        try:
            sender = await m.get_sender()
            name = sender.first_name or "Unknown"
        except:
            name = "Unknown"

        # –°–æ–æ–±—â–µ–Ω–∏–µ
        if m.text:
            text = m.text
        else:
            # –ï—Å–ª–∏ –º–µ–¥–∏–∞ ‚Äî —Ñ–∏–∫—Å–∏–º
            text = f"[–ú–µ–¥–∏–∞: {m.media}]"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É
        line = f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] {name}: {text}\n"

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º
        with open(log_file, "a", encoding="utf-8") as f:
            f.write(line)
