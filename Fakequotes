# meta developer: @B_Mods
from .. import loader, utils
from PIL import Image, ImageDraw, ImageFont
import io


class FakeQuotes(loader.Module):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–µ–π–∫–æ–≤—ã—Ö —Ü–∏—Ç–∞—Ç"""
    strings = {"name": "FakeQuotes"}

    # -------------------------------
    # .fquotes <name> <text>
    # -------------------------------
    @loader.command()
    async def fquotes(self, m):
        """–°–æ–∑–¥–∞—Ç—å —Ü–∏—Ç–∞—Ç—É –≤—Ä—É—á–Ω—É—é: .fquotes <name> <text>"""
        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n.fquotes <–∏–º—è> <—Ü–∏—Ç–∞—Ç–∞>")

        parts = args.split(maxsplit=1)
        if len(parts) < 2:
            return await m.edit("‚ùó –ù—É–∂–Ω–æ: .fquotes <–∏–º—è> <—Ü–∏—Ç–∞—Ç–∞>")

        name, text = parts[0], parts[1]

        await self.makequote(m, text, name)

    # -------------------------------
    # .fquo <text> (–≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    # -------------------------------
    @loader.command()
    async def fquo(self, m):
        """–°–æ–∑–¥–∞—Ç—å —Ü–∏—Ç–∞—Ç—É –∏–∑ —Ä–µ–ø–ª–∞—è: .fquo <—Ç–µ–∫—Å—Ç>"""
        reply = await m.get_reply_message()
        if not reply:
            return await m.edit("‚ùó –û—Ç–≤–µ—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ!")

        if not reply.sender:
            return await m.edit("‚ùó –ù–µ –º–æ–≥—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è.")

        name = reply.sender.first_name
        text = utils.get_args_raw(m)

        if not text:
            return await m.edit("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n–û—Ç–≤–µ—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí .fquo <—Ü–∏—Ç–∞—Ç–∞>")

        await self.makequote(m, text, name)

    # -------------------------------
    # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏
    # -------------------------------
    async def makequote(self, m, text, name):
        img = Image.new("RGB", (900, 600), "white")
        draw = ImageDraw.Draw(img)

        try:
            font = ImageFont.truetype("DejaVuSans.ttf", 36)
            smallfont = ImageFont.truetype("DejaVuSans.ttf", 28)
        except:
            font = ImageFont.load_default()
            smallfont = ImageFont.load_default()

        y = 100
        for line in utils.chunks(text, 35):
            draw.text((60, y), line, font=font, fill=(20, 20, 20))
            y += 55

        draw.text((60, 500), f"‚Äî {name}", font=smallfont, fill=(60, 60, 60))

        output = io.BytesIO()
        img.save(output, format="PNG")
        output.seek(0)

        await m.client.send_file(m.chat_id, output, caption="üñº –¶–∏—Ç–∞—Ç–∞")
        await m.delete()