# meta developer: @B_Mods
from .. import loader, utils
import io
from PIL import Image, ImageDraw, ImageFont, ImageOps
import requests

class FakeQuotesSticker(loader.Module):
    """Создание фейковых цитат в виде стикеров"""
    strings = {"name": "FakeQuotesSticker"}

    @loader.command()
    async def fquotes(self, m):
        """Создать цитату вручную: <юзер> <текст>"""
        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("Использование:\n.fquotes <имя> <текст>")

        parts = args.split(maxsplit=1)
        if len(parts) < 2:
            return await m.edit("❗ Нужно: .fquotes <имя> <текст>")

        name, text = parts[0], parts[1]
        await self.make_sticker(m, text, name, None)

    @loader.command()
    async def fquo(self, m):
        """Создать цитату по reply: <текст>"""
        reply = await m.get_reply_message()
        if not reply or not reply.sender:
            return await m.edit("❗ Ответь на сообщение с пользователем!")

        name = reply.sender.first_name
        text = utils.get_args_raw(m)
        if not text:
            return await m.edit("Использование:\nОтветь на сообщение → .fquo <текст>")

        # Получаем аватарку пользователя
        photo = None
        if reply.sender.photo:
            try:
                photo = await m.client.download_profile_photo(reply.sender)
            except:
                photo = None

        await self.make_sticker(m, text, name, photo)

    async def make_sticker(self, m, text, name, avatar_path):
        # Размер стикера
        size = 512
        margin = 30

        # Фон и тень
        img = Image.new("RGBA", (size, size), (255, 255, 255, 0))
        draw = ImageDraw.Draw(img)

        card = Image.new("RGBA", (size-40, size-40), (255, 255, 255, 255))
        shadow = Image.new("RGBA", card.size, (0,0,0,100))
        img.paste(shadow, (20, 20), shadow)
        img.paste(card, (20, 20))

        # Шрифт
        try:
            font = ImageFont.truetype("DejaVuSans.ttf", 28)
            smallfont = ImageFont.truetype("DejaVuSans.ttf", 22)
        except:
            font = ImageFont.load_default()
            smallfont = ImageFont.load_default()

        # Рисуем аватар, если есть
        if avatar_path:
            try:
                avatar = Image.open(avatar_path).convert("RGBA")
                avatar = avatar.resize((80, 80))
                img.paste(avatar, (30, 30))
            except:
                pass

        # Рисуем текст
        text_x = 130 if avatar_path else 30
        text_y = 50
        for line in utils.chunks(text, 25):
            draw.text((text_x, text_y), line, font=font, fill=(20, 20, 20, 255))
            text_y += 35

        # Подпись
        draw.text((text_x, size-60), f"— {name}", font=smallfont, fill=(60, 60, 60, 255))

        # Сохраняем в webp
        output = io.BytesIO()
        img.save(output, format="WEBP")
        output.seek(0)

        await m.client.send_file(m.chat_id, output, caption="✨ Стикер цитаты")
        await m.delete()