# meta developer: @B_Mods
from .. import loader, utils
from PIL import Image, ImageDraw, ImageFont
import io


@loader.tds
class FakeQuotesBarni(loader.Module):
    """Создание фейковых цитат в виде картинки (Barni Edition)"""
    strings = {"name": "FakeQuotesBarni"}

    def __init__(self):
        font_path = "modules/fonts/DejaVuSans.ttf"
        self.font = ImageFont.truetype(font_path, 38)
        self.smallfont = ImageFont.truetype(font_path, 30)

    async def make_sticker(self, m, text: str, name: str, avatar_bytes=None):
        img = Image.new("RGBA", (900, 600), (255, 255, 255, 255))
        draw = ImageDraw.Draw(img)

        # аватар
        if avatar_bytes:
            try:
                av = Image.open(io.BytesIO(avatar_bytes)).convert("RGBA")
                av = av.resize((150, 150))
                img.paste(av, (50, 50))
            except:
                pass

        # имя
        draw.text((220, 70), name, font=self.font, fill=(30, 30, 30))

        # перенос текста
        lines = []
        words = text.split(" ")
        line = ""
        for w in words:
            test = line + w + " "
            if draw.textlength(test, font=self.smallfont) < 620:
                line = test
            else:
                lines.append(line)
                line = w + " "
        lines.append(line)

        y = 200
        for l in lines:
            draw.text((60, y), l, font=self.smallfont, fill=(20, 20, 20))
            y += 60

        draw.text((60, 520), f"— {name}", font=self.smallfont, fill=(60, 60, 60))

        bio = io.BytesIO()
        bio.name = "quote.png"
        img.save(bio, "PNG")
        bio.seek(0)

        await m.reply(file=bio)

    @loader.command()
    async def fquotes(self, m):
        """.fquotes <юзер> <текст> — создать фейковую цитату"""
        args = utils.get_args_raw(m).split(" ", 1)
        if len(args) < 2:
            return await m.edit("Использование:\n.fquotes @user текст")

        user = args[0]
        text = args[1]

        try:
            ent = await m.client.get_entity(user)
        except:
            return await m.edit("❌ Не удалось получить пользователя")

        photo = await m.client.download_profile_photo(ent, bytes)
        name = ent.first_name or "User"

        await self.make_sticker(m, text, name, photo)

    @loader.command()
    async def fquo(self, m):
        """.fquo <текст> — создать цитату в ответ на сообщение"""
        if not m.is_reply:
            return await m.edit("Ответь на сообщение!")

        reply = await m.get_reply_message()
        name = reply.sender.first_name or "User"
        photo = await m.client.download_profile_photo(reply.sender, bytes)

        text = utils.get_args_raw(m)
        if not text:
            return await m.edit("Напиши текст цитаты!")

        await self.make_sticker(m, text, name, photo)