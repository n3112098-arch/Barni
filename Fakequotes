# meta developer: @B_Mods
from .. import loader, utils
import asyncio
from PIL import Image, ImageDraw, ImageFont
import base64, io


# ====== ВСТРОЕННЫЙ РАБОЧИЙ ШРИФТ (поддерживает русский) ======
FONT_DATA = b"""
AAEAAAASAQAABAAgR0RFRrRCsIIAAjWsAAACYkdQT1P/////AAO0AAAAFGNtYXAA
AAAAAAADsAAAACBnbHlm6rxeVQAAAxgAAA5laGVhZP////8AAAMQAAAANmhoZWEE
/////wAAAyQAAAAkaG10eP////8AAAOsAAAAGGxvY2EAAAAAAAADqAAAAAxtYXhw
AAAAgAAABOQAAAAgbmFtZf////8AAATYAAACaHBvc3T/////AAAFBAAAAChwcmVw
AAAAAAAFBAAAACR2dW5pAAABAAAAAQAAAAMAAAAA/wABAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAA==
"""

font_file = io.BytesIO(base64.b64decode(FONT_DATA))
FONT = ImageFont.truetype(font_file, size=38)
SMALLFONT = ImageFont.truetype(font_file, size=30)


# =============== МОДУЛЬ ===============
@loader.tds
class FakeQuotes(loader.Module):
    """Создание фейковых цитат в виде картинки"""
    strings = {"name": "FakeQuotes"}

    async def make_sticker(self, m, text: str, name: str, avatar_bytes=None):
        # холст
        img = Image.new("RGBA", (900, 600), (255, 255, 255, 255))
        draw = ImageDraw.Draw(img)

        # аватар
        if avatar_bytes:
            try:
                av = Image.open(io.BytesIO(avatar_bytes)).convert("RGBA")
                av = av.resize((150, 150))
                img.paste(av, (50, 50))
            except:
                pass

        # имя
        draw.text((220, 70), name, font=FONT, fill=(30, 30, 30))

        # текст цитаты
        lines = []
        words = text.split(" ")
        line = ""

        for w in words:
            test = line + w + " "
            if draw.textlength(test, font=SMALLFONT) < 620:
                line = test
            else:
                lines.append(line)
                line = w + " "
        lines.append(line)

        y = 200
        for l in lines:
            draw.text((60, y), l, font=SMALLFONT, fill=(20, 20, 20))
            y += 60

        # финальная подпись
        draw.text((60, 520), f"— {name}", font=SMALLFONT, fill=(60, 60, 60))

        # отправка
        bio = io.BytesIO()
        bio.name = "quote.png"
        img.save(bio, "PNG")
        bio.seek(0)

        await m.reply(file=bio)

    # ======= .fquotes <юзер> <текст> =======
    @loader.command()
    async def fquotes(self, m):
        """.fquotes <юзер> <текст> — создать фейковую цитату"""
        args = utils.get_args_raw(m).split(" ", 1)
        if len(args) < 2:
            return await m.edit("Использование:\n.fquotes @user текст")

        user = args[0]
        text = args[1]

        try:
            ent = await m.client.get_entity(user)
        except:
            return await m.edit("❌ Не удалось получить пользователя")

        # получаем аву
        photo = await m.client.download_profile_photo(ent, bytes)
        name = ent.first_name or "User"

        await self.make_sticker(m, text, name, photo)

    # ======= .fquo (ответ на сообщение) =======
    @loader.command()
    async def fquo(self, m):
        """.fquo <текст> — создать цитату в ответ на сообщение"""
        if not m.is_reply:
            return await m.edit("Ответь на сообщение!")

        reply = await m.get_reply_message()
        if not reply:
            return await m.edit("❌ Ошибка с ответом")

        name = reply.sender.first_name or "User"
        photo = await m.client.download_profile_photo(reply.sender, bytes)

        text = utils.get_args_raw(m)
        if not text:
            return await m.edit("Напиши текст цитаты!")

        await self.make_sticker(m, text, name, photo)