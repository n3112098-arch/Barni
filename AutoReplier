# Developed by @B_Mods
from .. import loader, utils
import asyncio
import random

class AutoReply(loader.Module):
    """–ê–≤—Ç–æ-–æ—Ç–≤–µ—Ç—á–∏–∫ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""

    strings = {"name": "AutoReply"}

    def __init__(self):
        self.running = {}

    @loader.command()
    async def rep(self, m):
        """
        .rep @user ‚Äî –Ω–∞—á–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        """
        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–£–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ` @username`")

        try:
            user = await m.client.get_entity(args)
        except:
            return await m.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

        uid = user.id
        chat = m.chat_id

        key = (chat, uid)
        if key in self.running and self.running[key]:
            return await m.edit("‚ö†Ô∏è –£–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

        self.running[key] = True
        await m.edit(f"ü§ñ –ê–≤—Ç–æ-–æ—Ç–≤–µ—Ç—á–∏–∫ –∑–∞–ø—É—â–µ–Ω –¥–ª—è {user.first_name}")

        asyncio.create_task(self._auto_reply(m, chat, uid))

    async def _auto_reply(self, m, chat, uid):
        while self.running.get((chat, uid), False):
            try:
                # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                msg_from_user = None
                async for msg in m.client.iter_messages(chat, from_user=uid, limit=1):
                    msg_from_user = msg
                    break

                if not msg_from_user:
                    await asyncio.sleep(4)
                    continue

                reply_msg_id = msg_from_user.id

                # –°–æ–±–∏—Ä–∞–µ–º 100 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤
                texts = []
                async for msg in m.client.iter_messages(chat, limit=150):
                    if msg.text:
                        texts.append(msg.text)

                if not texts:
                    await asyncio.sleep(4)
                    continue

                text = random.choice(texts)

                await m.client.send_message(
                    chat,
                    text,
                    reply_to=reply_msg_id
                )

                await asyncio.sleep(4)

            except Exception as e:
                # –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–∂–∏–º: –Ω–µ –ø–∞–¥–∞–µ–º
                await asyncio.sleep(4)

    @loader.command()
    async def repstop(self, m):
        """
        .repstop @user ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-–æ—Ç–≤–µ—Ç—á–∏–∫
        """
        args = utils.get_args_raw(m)
        if not args:
            return await m.edit("–£–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ` @username`")

        try:
            user = await m.client.get_entity(args)
        except:
            return await m.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

        uid = user.id
        key = (m.chat_id, uid)

        if key not in self.running or not self.running[key]:
            return await m.edit("‚ö†Ô∏è –ê–≤—Ç–æ-–æ—Ç–≤–µ—Ç—á–∏–∫ –Ω–µ –±—ã–ª –≤–∫–ª—é—á—ë–Ω.")

        self.running[key] = False
        await m.edit(f"üõë –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è {user.first_name}")
